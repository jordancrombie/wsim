# WSIM API Payment Integration Flows

> **Purpose:** Document the HTTP interactions between SSIM (merchant), WSIM Backend, WSIM Auth Server, and BSIM for all three API payment integration methods.
>
> **Audience:** Developers integrating wallet payments into merchant applications.

---

## Overview

WSIM provides three integration methods for wallet payments:

| Method | Description | Best For |
|--------|-------------|----------|
| **OIDC Redirect** | Full-page OAuth 2.0 authorization flow | Traditional e-commerce, server-rendered sites |
| **Popup** | Window.open popup with postMessage | Single-page apps, minimal UX disruption |
| **Merchant API** | Headless API with merchant-controlled UI | Custom checkout experiences, native apps |

All three methods ultimately authorize payment through NSIM using card tokens from BSIM.

---

## Services Involved

| Service | URL (Dev) | URL (Prod) | Role |
|---------|-----------|------------|------|
| **SSIM** | `https://ssim-dev.banksim.ca` | `https://ssim.banksim.ca` | Merchant simulator |
| **WSIM Frontend** | `https://wsim-dev.banksim.ca` | `https://wsim.banksim.ca` | Wallet UI |
| **WSIM Backend** | `https://wsim-dev.banksim.ca/api` | `https://wsim.banksim.ca/api` | Wallet API |
| **WSIM Auth Server** | `https://wsim-auth-dev.banksim.ca` | `https://wsim-auth.banksim.ca` | OAuth/OIDC, Passkey auth |
| **BSIM** | `https://bsim-dev.banksim.ca` | `https://bsim.banksim.ca` | Bank simulator (card tokens) |
| **NSIM** | `https://nsim-dev.banksim.ca` | `https://nsim.banksim.ca` | Payment network (authorization) |

---

## Token Types

| Token | Generated By | Lifetime | Purpose |
|-------|--------------|----------|---------|
| `walletCardToken` | WSIM | Persistent | Identifies card in WSIM, used for NSIM routing |
| `cardToken` (BSIM) | BSIM | 5 minutes | Short-lived token for card transaction |
| `access_token` (JWT) | WSIM Auth | 5 minutes | Contains both tokens in claims (OIDC flow) |
| `sessionId` | WSIM Auth | 14 days | User session cookie |

---

# CORS, Cookies, and Security Configuration

Cross-origin requests are fundamental to all three integration methods. This section explains the security configurations required for each flow.

## Cross-Origin Request Summary

| Flow | Cross-Origin? | Cookie Required? | CORS Required? | Special Headers |
|------|---------------|------------------|----------------|-----------------|
| OIDC Redirect | No (same origin after redirect) | Yes (WSIM session) | No | - |
| Popup | Yes (popup → opener) | Yes (cross-site) | No (postMessage) | `SameSite=None` |
| Merchant API | Yes (SSIM → WSIM) | Yes (cross-site) | Yes | `SameSite=None`, CORS headers |
| iframe Embed | Yes (parent → iframe) | Yes (cross-site) | No (postMessage) | `SameSite=None`, CSP frame-ancestors |

---

## Cookie Configuration

### Why SameSite=None is Required

For Popup, Merchant API, and iframe flows, session cookies must be sent in **cross-origin requests**. This requires:

1. **`SameSite=None`** - Allows cookies in cross-site contexts
2. **`Secure=true`** - Required when using `SameSite=None` (HTTPS only)
3. **`credentials: 'include'`** - Client must explicitly request cookies

### WSIM Backend Session Cookie

**File:** [backend/src/app.ts](../backend/src/app.ts)

```typescript
app.use(session({
  secret: env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  name: 'wsim.sid',
  cookie: {
    secure: true,           // Required for SameSite=None
    httpOnly: true,         // Prevent XSS access to cookie
    maxAge: 24 * 60 * 60 * 1000,  // 24 hours
    sameSite: 'none',       // Allow cross-origin requests
  },
}));

// Required for secure cookies behind reverse proxy (nginx)
app.set('trust proxy', 1);
```

### WSIM Auth Server Session Cookie

**File:** [auth-server/src/index.ts](../auth-server/src/index.ts)

```typescript
app.use(session({
  secret: env.COOKIE_SECRET,
  resave: false,
  saveUninitialized: false,
  name: 'wsim.popup.sid',
  cookie: {
    secure: true,           // Required for SameSite=None
    httpOnly: true,         // Prevent XSS access
    maxAge: 24 * 60 * 60 * 1000,  // 24 hours
    sameSite: 'none',       // Allow cross-origin popup/iframe
  },
}));

app.set('trust proxy', 1);
```

### Cookie Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ Cross-Site Cookie Flow (Merchant API Example)                               │
├─────────────────────────────────────────────────────────────────────────────┤

1. User logs into WSIM at wsim.banksim.ca
   ┌───────────────────┐
   │ wsim.banksim.ca   │
   │                   │ Set-Cookie: wsim.sid=abc123;
   │ Login successful  │            SameSite=None;
   │                   │            Secure;
   └───────────────────┘            HttpOnly

2. User visits SSIM at ssim.banksim.ca
   ┌───────────────────┐
   │ ssim.banksim.ca   │
   │                   │ Browser has wsim.sid cookie stored
   │ Checkout page     │ for wsim.banksim.ca domain
   └───────────────────┘

3. SSIM frontend calls WSIM API (cross-origin)
   ┌───────────────────┐           ┌───────────────────┐
   │ ssim.banksim.ca   │           │ wsim.banksim.ca   │
   │                   │           │                   │
   │ fetch(            │  ──────►  │ GET /api/merchant │
   │   wsim.../cards,  │           │     /cards        │
   │   {credentials:   │  Cookie:  │                   │
   │    'include'}     │  wsim.sid │ ✓ Cookie received │
   │ )                 │  =abc123  │ ✓ User identified │
   └───────────────────┘           └───────────────────┘

   Requirements for this to work:
   ✓ wsim.sid has SameSite=None; Secure
   ✓ WSIM server returns Access-Control-Allow-Credentials: true
   ✓ WSIM server returns Access-Control-Allow-Origin: https://ssim.banksim.ca
   ✓ SSIM client uses credentials: 'include'

└─────────────────────────────────────────────────────────────────────────────┘
```

---

## CORS Configuration

### WSIM Backend CORS

**File:** [backend/src/app.ts](../backend/src/app.ts)

```typescript
app.use(cors({
  origin: env.CORS_ORIGINS,     // ['https://ssim.banksim.ca', ...]
  credentials: true,             // Allow cookies in cross-origin requests
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-API-Key', 'x-api-key'],
}));
```

**Environment Variable:**
```env
CORS_ORIGINS=https://wsim.banksim.ca,https://ssim.banksim.ca,https://wsim-auth.banksim.ca
```

### CORS Headers Sent

When SSIM (origin: `https://ssim.banksim.ca`) calls WSIM Backend:

```http
HTTP/1.1 200 OK
Access-Control-Allow-Origin: https://ssim.banksim.ca
Access-Control-Allow-Credentials: true
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization, X-API-Key, x-api-key
```

### Preflight Requests (OPTIONS)

For non-simple requests (e.g., POST with JSON, custom headers), browsers send a preflight:

```http
OPTIONS /api/merchant/payment/initiate HTTP/1.1
Host: wsim.banksim.ca
Origin: https://ssim.banksim.ca
Access-Control-Request-Method: POST
Access-Control-Request-Headers: content-type, x-api-key
```

WSIM responds:

```http
HTTP/1.1 204 No Content
Access-Control-Allow-Origin: https://ssim.banksim.ca
Access-Control-Allow-Credentials: true
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization, X-API-Key, x-api-key
Access-Control-Max-Age: 86400
```

---

## Origin Validation

### Popup Flow Origin Validation

**File:** [auth-server/src/routes/popup.ts](../auth-server/src/routes/popup.ts)

```typescript
function isAllowedOrigin(origin: string | undefined): boolean {
  if (!origin) return false;
  return env.ALLOWED_POPUP_ORIGINS.includes(origin);
}

// Used in popup routes
router.get('/card-picker', async (req, res) => {
  const { origin } = req.query;

  if (!isAllowedOrigin(origin)) {
    return res.status(403).render('popup/error', {
      message: 'This origin is not authorized to use the wallet popup.',
    });
  }
  // ...
});
```

**Environment Variable:**
```env
ALLOWED_POPUP_ORIGINS=https://ssim.banksim.ca,https://ssim-dev.banksim.ca
```

### postMessage Origin Validation

In the popup, when sending tokens back:

```javascript
// Popup sends to opener - validates target origin
window.opener.postMessage(
  { type: 'wsim:card-selected', token: '...', ... },
  allowedOrigin  // Only sent to validated origin
);
```

In the merchant page, when receiving:

```javascript
window.addEventListener('message', (event) => {
  // Validate the message source
  if (event.origin !== 'https://wsim-auth.banksim.ca') {
    return; // Ignore messages from unknown origins
  }

  if (event.data.type === 'wsim:card-selected') {
    // Process token...
  }
});
```

---

## iframe Security (Embed Flow)

### CSP frame-ancestors

**File:** [auth-server/src/middleware/embed-headers.ts](../auth-server/src/middleware/embed-headers.ts)

```typescript
export function embedSecurityHeaders(req: Request, res: Response, next: NextFunction): void {
  const origin = req.query.origin as string;

  if (origin && env.ALLOWED_EMBED_ORIGINS.includes(origin)) {
    // Allow this specific origin to embed via CSP frame-ancestors
    res.setHeader('Content-Security-Policy', `frame-ancestors 'self' ${origin}`);

    // Permissions Policy for WebAuthn in iframe
    res.setHeader('Permissions-Policy',
      'publickey-credentials-get=(self), publickey-credentials-create=(self)');
  } else {
    // Block embedding from unknown origins
    res.setHeader('X-Frame-Options', 'DENY');
    res.setHeader('Content-Security-Policy', "frame-ancestors 'none'");
  }

  next();
}
```

**Environment Variable:**
```env
ALLOWED_EMBED_ORIGINS=https://ssim.banksim.ca,https://ssim-dev.banksim.ca
```

### iframe Requirements for WebAuthn

For passkey authentication to work inside an iframe:

```html
<!-- Merchant page embedding WSIM -->
<iframe
  src="https://wsim-auth.banksim.ca/embed/card-picker?origin=https://ssim.banksim.ca&..."
  allow="publickey-credentials-get *; publickey-credentials-create *"
></iframe>
```

The `allow` attribute grants the iframe permission to use WebAuthn APIs.

---

## CSRF Protection

### Why Traditional CSRF Tokens Are Not Used

WSIM uses **passkey-based authentication** instead of traditional CSRF tokens:

1. **Passkey verification is per-request** - Every payment confirmation requires biometric authentication
2. **Origin binding** - Passkeys are cryptographically bound to the RP ID (domain)
3. **Challenge-response** - Each action uses a unique, single-use challenge

### CSRF Mitigation Mechanisms

| Mechanism | Where Applied | Protection |
|-----------|---------------|------------|
| Passkey challenge | All payment confirmations | Per-request cryptographic verification |
| Origin validation | Popup/Embed routes | `isAllowedOrigin()` check |
| SameSite cookie | Session cookies | Prevents cookie attachment on cross-site form POSTs |
| API key | Merchant API | Identifies legitimate merchant |
| PKCE | OIDC flow | Prevents authorization code interception |

### State Parameter (OIDC Flow)

The `state` parameter in OIDC provides CSRF protection:

```typescript
// SSIM generates state before redirect
const state = generators.state();
req.session.paymentState = { state, ... };

// SSIM verifies state on callback
if (req.query.state !== paymentState.state) {
  return res.redirect('/checkout?error=state_mismatch');
}
```

---

## WebAuthn Origin Configuration

Passkeys are bound to the **Relying Party ID** (RP ID) which must match the domain.

### Multi-Origin WebAuthn

Since passkeys may be used from multiple contexts (WSIM frontend, popup, iframe, API), the origins must be configured:

**File:** [backend/src/config/env.ts](../backend/src/config/env.ts)

```typescript
WEBAUTHN_RP_ID: process.env.WEBAUTHN_RP_ID || 'banksim.ca',
WEBAUTHN_ORIGINS: process.env.WEBAUTHN_ORIGINS?.split(',') || [
  'https://wsim.banksim.ca',
  'https://wsim-auth.banksim.ca',
  'https://ssim.banksim.ca'  // For API flow passkey in merchant page
],
```

**Environment Variable:**
```env
WEBAUTHN_RP_ID=banksim.ca
WEBAUTHN_ORIGINS=https://wsim.banksim.ca,https://wsim-auth.banksim.ca,https://ssim.banksim.ca
```

### RP ID Domain Matching

The RP ID (`banksim.ca`) allows passkeys to work across all subdomains:

- `wsim.banksim.ca` - Main wallet frontend
- `wsim-auth.banksim.ca` - Auth server (popup/iframe)
- `ssim.banksim.ca` - Merchant page (API flow)

All share the same passkey registrations because the RP ID is the parent domain.

---

## Security Headers

### Helmet (WSIM Backend)

**File:** [backend/src/app.ts](../backend/src/app.ts)

```typescript
app.use(helmet());
```

Adds security headers:
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY` (unless overridden)
- `X-XSS-Protection: 1; mode=block`
- `Strict-Transport-Security: max-age=15552000; includeSubDomains`

---

## Troubleshooting

### Common CORS Errors

**Error:** `Access-Control-Allow-Origin missing`
```
Cause: WSIM CORS_ORIGINS doesn't include merchant origin
Fix: Add merchant origin to WSIM backend CORS_ORIGINS
```

**Error:** `Credentials not supported if origin is '*'`
```
Cause: Cannot use wildcard origin with credentials
Fix: Specify explicit origins in CORS_ORIGINS
```

**Error:** `Cookie not sent in cross-origin request`
```
Cause: Missing SameSite=None or Secure flag
Fix: Verify cookie configuration has sameSite: 'none' and secure: true
```

### Common Cookie Errors

**Error:** `Session not found` (401 on API calls)
```
Cause: Cookie not attached to cross-origin request
Fix:
  1. Verify SameSite=None; Secure on cookie
  2. Verify credentials: 'include' on fetch
  3. Verify CORS allows credentials
```

**Error:** `Cookie blocked by browser (SameSite warning)`
```
Cause: SameSite=None requires Secure flag
Fix: Ensure HTTPS is used (cookie won't work over HTTP)
```

### Common Passkey Errors

**Error:** `InvalidStateError: RP ID mismatch`
```
Cause: WEBAUTHN_RP_ID doesn't match domain
Fix: RP ID should be parent domain (banksim.ca) not subdomain
```

**Error:** `NotAllowedError: origin not allowed`
```
Cause: Request origin not in WEBAUTHN_ORIGINS
Fix: Add the origin to WEBAUTHN_ORIGINS environment variable
```

---

# Flow 1: OIDC Redirect

The traditional OAuth 2.0 Authorization Code flow with PKCE. User is redirected to WSIM for authentication and card selection.

## 1A: Unauthenticated User (No WSIM Session)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ OIDC Redirect Flow - Unauthenticated User                                   │
├─────────────────────────────────────────────────────────────────────────────┤

Step 1: SSIM initiates payment
══════════════════════════════

Browser                    SSIM                      WSIM Auth
   │                        │                            │
   ├─── POST /payment/initiate ──►                       │
   │    { provider: "wallet" }                           │
   │                        │                            │
   │                        │ (Create order, generate    │
   │                        │  PKCE state/nonce/verifier)│
   │                        │                            │
   │◄── 200 { redirectUrl } ┤                            │
   │                        │                            │


Step 2: Browser redirects to WSIM Auth
══════════════════════════════════════

Browser                    WSIM Auth                 WSIM Backend
   │                           │                          │
   ├─── GET /auth/authorization ──►                       │
   │    ?client_id=ssim-merchant                          │
   │    &redirect_uri=https://ssim.../payment/wallet-callback
   │    &scope=openid payment:authorize                   │
   │    &response_type=code                               │
   │    &code_challenge=<base64url>                       │
   │    &code_challenge_method=S256                       │
   │    &state=<random>                                   │
   │    &nonce=<random>                                   │
   │    &resource=urn:wsim:payment-api                    │
   │    &claims={"payment":{"amount":"104.99",...}}       │
   │                           │                          │
   │◄── 303 /interaction/{uid} ┤                          │
   │                           │                          │


Step 3: User authenticates (passkey or password)
════════════════════════════════════════════════

Browser                    WSIM Auth                 Prisma DB
   │                           │                          │
   ├─── GET /interaction/{uid} ──►                        │
   │                           │                          │
   │◄── 200 Login Page ────────┤                          │
   │    (passkey option shown)                            │
   │                           │                          │
   ├─── POST /interaction/{uid}/passkey/options ──►       │
   │                           │                          │
   │◄── 200 { challenge, ... } ┤                          │
   │                           │                          │
   │ [User performs biometric] │                          │
   │                           │                          │
   ├─── POST /interaction/{uid}/passkey/verify ──►        │
   │    { response: <WebAuthn> }                          │
   │                           │                          │
   │                           ├─── Find credential ──────►
   │                           ◄─── Credential found ─────┤
   │                           │                          │
   │                           │ (Verify signature,       │
   │                           │  update counter,         │
   │                           │  create session)         │
   │                           │                          │
   │◄── 303 /interaction/{uid} ┤                          │
   │    Set-Cookie: session=xxx                           │


Step 4: User selects card and confirms payment
══════════════════════════════════════════════

Browser                    WSIM Auth                 WSIM Backend          BSIM
   │                           │                          │                  │
   ├─── GET /interaction/{uid}/card-select ──►            │                  │
   │                           │                          │                  │
   │                           ├─── GET user's cards ─────►                  │
   │                           ◄─── Cards list ───────────┤                  │
   │                           │                          │                  │
   │◄── 200 Card Selection Page                           │                  │
   │    "Select card for $104.99 to SSIM"                 │                  │
   │                           │                          │                  │
   ├─── POST /interaction/{uid}/select-card ──►           │                  │
   │    { cardId: "uuid" }     │                          │                  │
   │                           │                          │                  │
   │                           ├─── POST /api/payment/request-token ──►      │
   │                           │    Authorization: Bearer {INTERNAL_API_SECRET}
   │                           │    { walletCardId, merchantId, amount }     │
   │                           │                          │                  │
   │                           │                          ├── POST /api/wallet/tokens ──►
   │                           │                          │   Auth: Bearer {walletCredential}
   │                           │                          │   { cardId, merchantId, amount }
   │                           │                          │                  │
   │                           │                          ◄── { token, expiresAt } ──┤
   │                           │                          │                  │
   │                           ◄── { cardToken, walletCardToken } ──┤        │
   │                           │                          │                  │
   │                           │ (Store in PaymentContext │                  │
   │                           │  for token claims)       │                  │
   │                           │                          │                  │
   │◄── 303 /auth/authorization/{uid}/complete            │                  │


Step 5: OIDC Provider issues authorization code
═══════════════════════════════════════════════

Browser                    WSIM Auth
   │                           │
   │ (OIDC provider generates  │
   │  auth code, stores grant) │
   │                           │
   │◄── 303 redirect to SSIM ──┤
   │    ?code=xxx&state=xxx    │


Step 6: SSIM exchanges code for tokens
══════════════════════════════════════

Browser                    SSIM                      WSIM Auth
   │                        │                            │
   ├─── GET /payment/wallet-callback ──►                 │
   │    ?code=xxx&state=xxx │                            │
   │                        │                            │
   │                        ├─── POST /token ────────────►
   │                        │    grant_type=authorization_code
   │                        │    code=xxx                │
   │                        │    code_verifier=xxx       │
   │                        │    redirect_uri=xxx        │
   │                        │    resource=urn:wsim:payment-api
   │                        │                            │
   │                        ◄─── 200 { access_token, id_token } ──┤
   │                        │                            │
   │                        │ (Decode JWT access_token:  │
   │                        │  { wallet_card_token: "...",
   │                        │    card_token: "...",      │
   │                        │    payment_amount: "...",  │
   │                        │    sub: "user-id" })       │


Step 7: SSIM authorizes payment with NSIM
═════════════════════════════════════════

SSIM                       NSIM
   │                        │
   ├─── POST /api/payments/authorize ──►
   │    { merchantId: "ssim-merchant",
   │      amount: 10499,
   │      currency: "CAD",
   │      cardToken: "xxx",
   │      walletCardToken: "xxx",
   │      orderId: "order-123" }
   │                        │
   ◄─── 200 { status: "authorized",
   │         transactionId: "txn-xxx",
   │         authorizationCode: "xxx" } ──┤


Step 8: User redirected to order confirmation
═════════════════════════════════════════════

Browser                    SSIM
   │                        │
   │◄── 303 /order-confirmation/{orderId} ──┤

└─────────────────────────────────────────────────────────────────────────────┘
```

## 1B: Authenticated User (Has WSIM Session)

When user already has a valid WSIM session cookie, the flow skips authentication:

```
Steps 1-2: Same as above (SSIM initiates, browser redirects)

Step 3: SKIPPED - Session cookie recognized

Step 4: Directly show card selection (session already valid)

Steps 5-8: Same as above
```

**Key HTTP Difference:**
- Request to `/interaction/{uid}` includes valid `session` cookie
- Server recognizes session, skips login page
- Directly renders card selection

---

# Flow 2: Popup

User stays on merchant site. WSIM opens in a popup window for card selection.

## 2A: Unauthenticated User (No WSIM Session)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ Popup Flow - Unauthenticated User                                           │
├─────────────────────────────────────────────────────────────────────────────┤

Step 1: SSIM opens popup
════════════════════════

SSIM Page (Browser)
   │
   │ window.open(
   │   'https://wsim-auth.../popup/card-picker' +
   │   '?merchantId=ssim-merchant' +
   │   '&merchantName=SSIM Store' +
   │   '&amount=104.99' +
   │   '&currency=CAD' +
   │   '&orderId=order-123' +
   │   '&origin=https://ssim.banksim.ca',
   │   'wsim-wallet',
   │   'width=420,height=620,popup=true'
   │ )
   │
   │ // Set up message listener
   │ window.addEventListener('message', handleWsimMessage)


Step 2: Popup validates origin and checks session
═════════════════════════════════════════════════

Popup Window                WSIM Auth Server
   │                            │
   ├─── GET /popup/card-picker ──►
   │    ?origin=https://ssim...  │
   │    (No session cookie)      │
   │                            │
   │                            │ (Validate origin against
   │                            │  ALLOWED_POPUP_ORIGINS)
   │                            │
   │◄── 200 Auth Required Page ──┤
   │    "Sign in to continue"   │


Step 3: User authenticates with passkey (discoverable credentials)
══════════════════════════════════════════════════════════════════

Popup Window                WSIM Auth Server          Prisma DB
   │                            │                        │
   ├─── POST /popup/login/options ──►                    │
   │                            │                        │
   │◄── 200 {                   │                        │
   │      challenge: "xxx",     │                        │
   │      rpId: "banksim.ca",   │                        │
   │      userVerification: "preferred",                 │
   │      _tempKey: "login_xxx" │                        │
   │    }                       │                        │
   │                            │                        │
   │ [Browser prompts passkey]  │                        │
   │ [User performs biometric]  │                        │
   │                            │                        │
   ├─── POST /popup/login/verify ──►                     │
   │    { response: <WebAuthn>, │                        │
   │      _tempKey: "login_xxx" }                        │
   │                            │                        │
   │                            ├─── Find credential by ID ──►
   │                            ◄─── Credential + User ──────┤
   │                            │                        │
   │                            │ (Verify signature,     │
   │                            │  update counter,       │
   │                            │  set session.userId)   │
   │                            │                        │
   │◄── 200 { success: true, user: {...} } ──┤           │
   │    Set-Cookie: session=xxx │                        │


Step 4: Popup reloads with session, shows cards
═══════════════════════════════════════════════

Popup Window                WSIM Auth Server          Prisma DB
   │                            │                        │
   ├─── GET /popup/card-picker ──►                       │
   │    Cookie: session=xxx     │                        │
   │                            │                        │
   │                            ├─── Get user's cards ───►
   │                            ◄─── Cards list ─────────┤
   │                            │                        │
   │◄── 200 Card Picker Page ───┤                        │
   │    [Card 1: Visa ****4242] │                        │
   │    [Card 2: MC ****5555]   │                        │


Step 5: User selects card, confirms with passkey
════════════════════════════════════════════════

Popup Window                WSIM Auth Server          WSIM Backend          BSIM
   │                            │                          │                  │
   │ [User clicks "Pay with     │                          │                  │
   │  Visa ****4242"]           │                          │                  │
   │                            │                          │                  │
   ├─── POST /popup/passkey/options ──►                    │                  │
   │    { userId: "xxx",        │                          │                  │
   │      walletCardId: "xxx",  │                          │                  │
   │      merchantName: "SSIM", │                          │                  │
   │      amount: 104.99,       │                          │                  │
   │      currency: "CAD" }     │                          │                  │
   │                            │                          │                  │
   │◄── 200 {                   │                          │                  │
   │      challenge: "xxx",     │                          │                  │
   │      allowCredentials: [...],                         │                  │
   │      _challengeKey: "popup_xxx_123"                   │                  │
   │    }                       │                          │                  │
   │                            │                          │                  │
   │ [Browser prompts passkey]  │                          │                  │
   │ [User confirms payment]    │                          │                  │
   │                            │                          │                  │
   ├─── POST /popup/passkey/verify ──►                     │                  │
   │    { response: <WebAuthn>, │                          │                  │
   │      _challengeKey: "xxx", │                          │                  │
   │      walletCardId: "xxx",  │                          │                  │
   │      merchantId: "ssim",   │                          │                  │
   │      origin: "https://ssim..." }                      │                  │
   │                            │                          │                  │
   │                            │ (Verify passkey,         │                  │
   │                            │  validate origin)        │                  │
   │                            │                          │                  │
   │                            ├─── POST /api/payment/request-token ──►      │
   │                            │    Authorization: Bearer {INTERNAL_API_SECRET}
   │                            │                          │                  │
   │                            │                          ├── POST /api/wallet/tokens ──►
   │                            │                          │   { cardId, amount, ... }
   │                            │                          │                  │
   │                            │                          ◄── { token } ─────┤
   │                            │                          │                  │
   │                            ◄── { cardToken, walletCardToken } ──┤        │
   │                            │                          │                  │
   │◄── 200 {                   │                          │                  │
   │      success: true,        │                          │                  │
   │      token: "wallet_card_token",                      │                  │
   │      cardToken: "bsim_token",                         │                  │
   │      cardLast4: "4242",    │                          │                  │
   │      cardBrand: "visa",    │                          │                  │
   │      expiresAt: "2024-12-06T12:05:00Z"                │                  │
   │    }                       │                          │                  │


Step 6: Popup sends token to opener via postMessage
════════════════════════════════════════════════════

Popup Window                SSIM Page (Opener)
   │                            │
   │ window.opener.postMessage({│
   │   type: 'wsim:card-selected',
   │   token: 'wallet_card_token',
   │   cardToken: 'bsim_token', │
   │   cardLast4: '4242',       │
   │   cardBrand: 'visa',       │
   │   expiresAt: '2024-12-06T12:05:00Z'
   │ }, 'https://ssim.banksim.ca')
   │                            │
   │ window.close()             │
   │                            │
   │                       ────►│ handleWsimMessage(event)
   │                            │


Step 7: SSIM completes payment
══════════════════════════════

SSIM Page                  SSIM Backend              NSIM
   │                           │                       │
   ├─── POST /payment/popup-complete ──►               │
   │    { cardToken: "xxx",    │                       │
   │      cardLast4: "4242",   │                       │
   │      cardBrand: "visa" }  │                       │
   │                           │                       │
   │                           ├── POST /api/payments/authorize ──►
   │                           │   { cardToken, amount, ... }
   │                           │                       │
   │                           ◄── { status: "authorized" } ──┤
   │                           │                       │
   │◄── 200 {                  │                       │
   │      success: true,       │                       │
   │      orderId: "xxx",      │                       │
   │      transactionId: "txn-xxx",
   │      redirectUrl: "/order-confirmation/xxx"
   │    }                      │                       │

└─────────────────────────────────────────────────────────────────────────────┘
```

## 2B: Authenticated User (Has WSIM Session)

When user has valid WSIM session:

```
Step 1: Same - SSIM opens popup

Step 2: Popup GET /popup/card-picker includes session cookie
       → Server recognizes session
       → Directly renders card picker (skips auth-required page)

Steps 3: SKIPPED - Already authenticated

Steps 4-7: Same as above
```

---

# Flow 3: Merchant API

Merchant builds custom UI, uses WSIM API for card list and payment confirmation.

## 3A: Unauthenticated User (No WSIM Session)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ Merchant API Flow - Unauthenticated User                                    │
├─────────────────────────────────────────────────────────────────────────────┤

Step 1: SSIM checks WSIM auth status
════════════════════════════════════

SSIM Page                  SSIM Backend              WSIM Backend
   │                           │                          │
   ├─── GET /api/wsim/auth-check ──►                      │
   │                           │                          │
   │                           ├─── GET /api/merchant/user ──►
   │                           │    x-api-key: wsim_api_xxx
   │                           │    Cookie: (forwarded)   │
   │                           │                          │
   │                           ◄─── 200 { authenticated: false } ──┤
   │                           │                          │
   │◄── 200 { authenticated: false } ──┤                  │


Step 2: SSIM shows "Connect Wallet" or opens popup for auth
═══════════════════════════════════════════════════════════

Two options:
A) Open WSIM popup just for authentication (no payment)
B) Redirect to WSIM login page with return URL

For option A (popup auth):

SSIM Page                  Popup Window              WSIM Auth
   │                           │                         │
   │ window.open(              │                         │
   │   'https://wsim-auth.../popup/card-picker?...',     │
   │   'wsim-auth'             │                         │
   │ )                         │                         │
   │                           │                         │
   │                     ──────►                         │
   │                           ├── GET /popup/card-picker ──►
   │                           │   (No session)          │
   │                           │                         │
   │                           ◄── 200 Auth Required ────┤
   │                           │                         │
   │                           │ [User authenticates     │
   │                           │  with passkey]          │
   │                           │                         │
   │                           │ Set-Cookie: session=xxx │
   │                           │                         │
   │                           ◄── Card Picker Page ─────┤
   │                           │                         │
   │                           │ [User can close popup   │
   │                           │  or select card]        │
   │                           │                         │
   │◄── postMessage (wsim:card-selected OR popup closes) ──┤


Step 3: SSIM fetches cards via API (now authenticated)
══════════════════════════════════════════════════════

SSIM Page                  SSIM Backend              WSIM Backend          Prisma DB
   │                           │                          │                    │
   ├─── GET /api/wsim/cards ───►                          │                    │
   │                           │                          │                    │
   │                           ├─── GET /api/merchant/cards ──►                │
   │                           │    x-api-key: wsim_api_xxx                    │
   │                           │    Cookie: session=xxx   │                    │
   │                           │                          │                    │
   │                           │                          ├── Query cards ─────►
   │                           │                          ◄── Cards ───────────┤
   │                           │                          │                    │
   │                           ◄── 200 {                  │                    │
   │                           │     cards: [{            │                    │
   │                           │       id: "uuid",        │                    │
   │                           │       lastFour: "4242",  │                    │
   │                           │       cardType: "VISA",  │                    │
   │                           │       bankName: "Bank Simulator",             │
   │                           │       isDefault: true    │                    │
   │                           │     }]                   │                    │
   │                           │   }                      │                    │
   │                           │                          │                    │
   │◄── 200 { cards: [...] }   │                          │                    │


Step 4: User selects card, SSIM initiates payment
═════════════════════════════════════════════════

SSIM Page                  SSIM Backend              WSIM Backend
   │                           │                          │
   │ [User clicks on card]     │                          │
   │                           │                          │
   ├─── POST /api/wsim/payment/initiate ──►               │
   │    { cardId: "uuid",      │                          │
   │      amount: 104.99,      │                          │
   │      currency: "CAD" }    │                          │
   │                           │                          │
   │                           ├── POST /api/merchant/payment/initiate ──►
   │                           │   x-api-key: wsim_api_xxx│
   │                           │   Cookie: session=xxx   │
   │                           │   { cardId, amount, currency, merchantName }
   │                           │                          │
   │                           │                          │ (Verify card belongs
   │                           │                          │  to user, get passkeys,
   │                           │                          │  generate challenge)
   │                           │                          │
   │                           ◄── 200 {                  │
   │                           │     paymentId: "pay_xxx",│
   │                           │     passkeyOptions: {    │
   │                           │       challenge: "xxx",  │
   │                           │       rpId: "banksim.ca",│
   │                           │       allowCredentials: [...]
   │                           │     },                   │
   │                           │     card: { lastFour, cardType }
   │                           │   }                      │
   │                           │                          │
   │◄── 200 { paymentId, passkeyOptions, card } ──┤       │


Step 5: User confirms with passkey (in SSIM page)
═════════════════════════════════════════════════

SSIM Page (Browser)
   │
   │ // Call WebAuthn API
   │ const credential = await navigator.credentials.get({
   │   publicKey: passkeyOptions
   │ })
   │
   │ // User performs biometric authentication
   │


Step 6: SSIM confirms payment with passkey response
═══════════════════════════════════════════════════

SSIM Page                  SSIM Backend              WSIM Backend          BSIM
   │                           │                          │                  │
   ├─── POST /api/wsim/payment/confirm ──►                │                  │
   │    { paymentId: "pay_xxx",│                          │                  │
   │      passkeyResponse: {...} }                        │                  │
   │                           │                          │                  │
   │                           ├── POST /api/merchant/payment/confirm ──►    │
   │                           │   x-api-key: wsim_api_xxx│                  │
   │                           │   { paymentId, passkeyResponse }            │
   │                           │                          │                  │
   │                           │                          │ (Verify passkey) │
   │                           │                          │                  │
   │                           │                          ├── POST /api/wallet/tokens ──►
   │                           │                          │   Auth: Bearer {walletCredential}
   │                           │                          │   { cardId, amount, ... }
   │                           │                          │                  │
   │                           │                          ◄── { token } ─────┤
   │                           │                          │                  │
   │                           ◄── 200 {                  │                  │
   │                           │     success: true,       │                  │
   │                           │     token: "wallet_card_token",             │
   │                           │     cardToken: "bsim_token",                │
   │                           │     cardLast4: "4242",   │                  │
   │                           │     cardBrand: "visa",   │                  │
   │                           │     expiresAt: "..."     │                  │
   │                           │   }                      │                  │
   │                           │                          │                  │
   │◄── 200 { success, token, cardToken, ... } ──┤        │                  │


Step 7: SSIM authorizes payment with NSIM
═════════════════════════════════════════

SSIM Page                  SSIM Backend              NSIM
   │                           │                       │
   ├─── POST /api/wsim/payment/complete ──►            │
   │    { walletCardToken, cardToken,                  │
   │      cardLast4, cardBrand }                       │
   │                           │                       │
   │                           ├── POST /api/payments/authorize ──►
   │                           │   { merchantId, amount, currency,
   │                           │     cardToken, walletCardToken }
   │                           │                       │
   │                           ◄── { status: "authorized" } ──┤
   │                           │                       │
   │◄── 200 {                  │                       │
   │      success: true,       │                       │
   │      orderId: "xxx",      │                       │
   │      transactionId: "txn-xxx"
   │    }                      │                       │

└─────────────────────────────────────────────────────────────────────────────┘
```

## 3B: Authenticated User (Has WSIM Session)

When user already has WSIM session (e.g., logged in previously):

```
Step 1: GET /api/merchant/user returns { authenticated: true }

Step 2: SKIPPED - No auth needed

Steps 3-7: Same as above (fetch cards, initiate, confirm, complete)
```

**Key Difference:** No popup or redirect needed for authentication.

---

# HTTP Request/Response Reference

## OIDC Flow Endpoints

### Authorization Request
```http
GET /auth/authorization HTTP/1.1
Host: wsim-auth.banksim.ca

Query Parameters:
  client_id=ssim-merchant
  redirect_uri=https://ssim.banksim.ca/payment/wallet-callback
  scope=openid payment:authorize
  response_type=code
  code_challenge=<base64url-encoded-sha256>
  code_challenge_method=S256
  state=<random-state>
  nonce=<random-nonce>
  resource=urn:wsim:payment-api
  claims={"payment":{"amount":"104.99","currency":"CAD","merchantId":"ssim","orderId":"order-123"}}
```

### Token Exchange
```http
POST /token HTTP/1.1
Host: wsim-auth.banksim.ca
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&code=<authorization-code>
&code_verifier=<pkce-verifier>
&redirect_uri=https://ssim.banksim.ca/payment/wallet-callback
&resource=urn:wsim:payment-api
```

Response:
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 300,
  "id_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

JWT Access Token Claims:
```json
{
  "sub": "user-uuid",
  "aud": "ssim-merchant",
  "wallet_card_token": "wct_xxx",
  "card_token": "bsim_jwt_xxx",
  "payment_amount": "104.99",
  "payment_currency": "CAD",
  "exp": 1733496300
}
```

---

## Popup Flow Endpoints

### Login Options (Discoverable Credentials)
```http
POST /popup/login/options HTTP/1.1
Host: wsim-auth.banksim.ca
Content-Type: application/json

{}
```

Response:
```json
{
  "challenge": "base64url-challenge",
  "rpId": "banksim.ca",
  "userVerification": "preferred",
  "_tempKey": "login_abc123"
}
```

### Login Verify
```http
POST /popup/login/verify HTTP/1.1
Host: wsim-auth.banksim.ca
Content-Type: application/json

{
  "response": { /* WebAuthn AuthenticatorAssertionResponse */ },
  "_tempKey": "login_abc123"
}
```

Response:
```json
{
  "success": true,
  "user": {
    "id": "user-uuid",
    "email": "user@example.com"
  }
}
```

### Passkey Options (Payment Confirmation)
```http
POST /popup/passkey/options HTTP/1.1
Host: wsim-auth.banksim.ca
Content-Type: application/json

{
  "userId": "user-uuid",
  "walletCardId": "card-uuid",
  "merchantName": "SSIM Store",
  "amount": 104.99,
  "currency": "CAD"
}
```

### Passkey Verify
```http
POST /popup/passkey/verify HTTP/1.1
Host: wsim-auth.banksim.ca
Content-Type: application/json

{
  "response": { /* WebAuthn response */ },
  "_challengeKey": "popup_xxx_123",
  "walletCardId": "card-uuid",
  "merchantId": "ssim-merchant",
  "merchantName": "SSIM Store",
  "amount": 104.99,
  "currency": "CAD",
  "origin": "https://ssim.banksim.ca"
}
```

Response:
```json
{
  "success": true,
  "token": "wct_xxx",
  "cardToken": "bsim_jwt_xxx",
  "cardLast4": "4242",
  "cardBrand": "visa",
  "expiresAt": "2024-12-06T12:05:00.000Z"
}
```

---

## Merchant API Endpoints

All requests require:
- Header: `x-api-key: wsim_api_xxx`
- Cookie: WSIM session cookie (forwarded from user's browser)

### Check Auth
```http
GET /api/merchant/user HTTP/1.1
Host: wsim.banksim.ca
x-api-key: wsim_api_xxx
Cookie: session=xxx
```

### List Cards
```http
GET /api/merchant/cards HTTP/1.1
Host: wsim.banksim.ca
x-api-key: wsim_api_xxx
Cookie: session=xxx
```

### Initiate Payment
```http
POST /api/merchant/payment/initiate HTTP/1.1
Host: wsim.banksim.ca
x-api-key: wsim_api_xxx
Cookie: session=xxx
Content-Type: application/json

{
  "cardId": "card-uuid",
  "amount": 104.99,
  "currency": "CAD",
  "merchantName": "SSIM Store"
}
```

### Confirm Payment
```http
POST /api/merchant/payment/confirm HTTP/1.1
Host: wsim.banksim.ca
x-api-key: wsim_api_xxx
Content-Type: application/json

{
  "paymentId": "pay_xxx",
  "passkeyResponse": { /* WebAuthn response */ }
}
```

---

## Internal Service Endpoints

### Request Token (Auth Server → Backend)
```http
POST /api/payment/request-token HTTP/1.1
Host: wsim-backend:3001
Authorization: Bearer {INTERNAL_API_SECRET}
Content-Type: application/json

{
  "walletCardId": "card-uuid",
  "merchantId": "ssim-merchant",
  "merchantName": "SSIM Store",
  "amount": 104.99,
  "currency": "CAD"
}
```

### Get Card Token (Backend → BSIM)
```http
POST /api/wallet/tokens HTTP/1.1
Host: bsim.banksim.ca
Authorization: Bearer {walletCredential}
Content-Type: application/json

{
  "cardId": "bsim-card-ref",
  "merchantId": "ssim-merchant",
  "amount": 104.99,
  "currency": "CAD"
}
```

---

## postMessage Protocol

### Card Selected
```javascript
{
  type: 'wsim:card-selected',
  token: 'wct_xxx',           // walletCardToken
  cardToken: 'bsim_jwt_xxx',  // BSIM card token
  cardLast4: '4242',
  cardBrand: 'visa',
  expiresAt: '2024-12-06T12:05:00.000Z'
}
```

### Cancelled
```javascript
{
  type: 'wsim:cancelled',
  reason: 'user' | 'timeout' | 'error'
}
```

### Auth Required
```javascript
{
  type: 'wsim:auth-required',
  message: 'Please sign in to continue'
}
```

### Error
```javascript
{
  type: 'wsim:error',
  code: 'passkey_failed' | 'token_error' | 'origin_invalid',
  message: 'Human-readable error message'
}
```

---

## Error Responses

| HTTP Status | Error Code | Description |
|-------------|------------|-------------|
| 400 | `bad_request` | Missing required parameters |
| 400 | `invalid_payment` | Payment session expired |
| 400 | `passkey_failed` | Passkey verification failed |
| 400 | `no_passkeys` | User has no registered passkeys |
| 401 | `missing_api_key` | No x-api-key header |
| 401 | `invalid_api_key` | API key not found |
| 401 | `not_authenticated` | User session not found |
| 403 | `origin_invalid` | Origin not in allowed list |
| 404 | `card_not_found` | Card doesn't exist or not owned by user |
| 502 | `bsim_error` | Failed to get token from BSIM |

---

# Implementation Code Examples

This section provides complete code examples for implementing the three API integration modes. These examples mirror the code structure found in the SSIM reference implementation.

## Overview of API Modes

| Mode | Description | API Calls From | CORS Required? | Use Case |
|------|-------------|----------------|----------------|----------|
| **Direct API** | Browser calls WSIM directly | Browser | Yes | Simplest integration, full CORS support |
| **Proxy Mode** | Browser → Merchant → WSIM | Merchant Backend | No (backend-to-backend) | No CORS needed, hides API key |
| **API Mode** | Hybrid - backend proxy with frontend WebAuthn | Both | Partial | Backend handles API calls, browser handles passkey |

---

# Direct API Mode (Browser → WSIM)

The browser makes API calls directly to WSIM. This requires WSIM to allow your merchant origin in CORS configuration.

## Prerequisites

```env
# Merchant needs these from WSIM
WSIM_API_URL=https://wsim.banksim.ca/api/merchant
WSIM_API_KEY=wsim_api_xxx
```

WSIM must have your origin in `CORS_ORIGINS`:
```env
# WSIM Backend .env
CORS_ORIGINS=https://your-merchant.com,https://wsim.banksim.ca
```

## Frontend Implementation

### Step 1: Configuration

```javascript
// Configuration - these can be injected from your backend
const WSIM_API_URL = 'https://wsim.banksim.ca/api/merchant';
const WSIM_API_KEY = 'wsim_api_xxx';
const WSIM_POPUP_URL = 'https://wsim-auth.banksim.ca';

let selectedCardId = null;
let paymentId = null;
```

### Step 2: Check Authentication Status

```javascript
async function checkWsimAuth() {
  try {
    const response = await fetch(`${WSIM_API_URL}/user`, {
      method: 'GET',
      credentials: 'include',  // CRITICAL: Send cookies cross-origin
      headers: {
        'X-API-Key': WSIM_API_KEY,
      },
    });

    const data = await response.json();
    return data.authenticated === true;
  } catch (error) {
    // CORS error or network failure
    console.error('Auth check failed:', error);
    return false;
  }
}
```

### Step 3: Fetch User's Cards

```javascript
async function fetchCards() {
  const response = await fetch(`${WSIM_API_URL}/cards`, {
    method: 'GET',
    credentials: 'include',
    headers: {
      'X-API-Key': WSIM_API_KEY,
    },
  });

  if (!response.ok) {
    throw new Error('Failed to fetch cards');
  }

  const data = await response.json();
  return data.cards || [];
}
```

### Step 4: Render Card Selection UI

```javascript
function renderCards(cards, containerId) {
  const container = document.getElementById(containerId);

  if (cards.length === 0) {
    container.innerHTML = '<p>No cards enrolled in your wallet.</p>';
    return;
  }

  container.innerHTML = cards.map(card => `
    <div
      class="card-option ${card.isDefault ? 'selected' : ''}"
      onclick="selectCard('${card.id}')"
      data-card-id="${card.id}"
    >
      <div class="card-icon ${card.cardType.toLowerCase()}"></div>
      <div class="card-details">
        <span class="card-type">${card.cardType} •••• ${card.lastFour}</span>
        <span class="card-bank">${card.bankName || ''}</span>
      </div>
      ${card.isDefault ? '<span class="default-badge">Default</span>' : ''}
    </div>
  `).join('');

  // Auto-select default card
  const defaultCard = cards.find(c => c.isDefault);
  if (defaultCard) {
    selectCard(defaultCard.id);
  }
}

function selectCard(cardId) {
  selectedCardId = cardId;

  // Update UI to show selection
  document.querySelectorAll('.card-option').forEach(el => {
    el.classList.toggle('selected', el.dataset.cardId === cardId);
  });

  // Enable confirm button
  document.getElementById('confirmButton').disabled = false;
}
```

### Step 5: Initiate Payment (Get Passkey Challenge)

```javascript
async function initiatePayment(amount, currency = 'CAD') {
  if (!selectedCardId) {
    throw new Error('No card selected');
  }

  const response = await fetch(`${WSIM_API_URL}/payment/initiate`, {
    method: 'POST',
    credentials: 'include',
    headers: {
      'X-API-Key': WSIM_API_KEY,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      cardId: selectedCardId,
      amount: amount.toFixed(2),  // e.g., "104.99"
      currency: currency,
      merchantName: 'Your Store Name',
    }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'Failed to initiate payment');
  }

  const data = await response.json();
  paymentId = data.paymentId;

  return data;  // { paymentId, passkeyOptions, card }
}
```

### Step 6: Trigger Passkey Authentication

```javascript
// Import SimpleWebAuthn browser library
// <script src="https://cdn.jsdelivr.net/npm/@simplewebauthn/browser@10/dist/bundle/index.umd.min.js"></script>

async function authenticateWithPasskey(passkeyOptions) {
  // Use SimpleWebAuthn to trigger browser passkey prompt
  const { startAuthentication } = SimpleWebAuthnBrowser;

  try {
    const assertion = await startAuthentication(passkeyOptions);
    return assertion;
  } catch (error) {
    if (error.name === 'NotAllowedError') {
      throw new Error('Passkey authentication was cancelled');
    }
    throw error;
  }
}
```

### Step 7: Confirm Payment (Verify Passkey)

```javascript
async function confirmPayment(passkeyResponse) {
  const response = await fetch(`${WSIM_API_URL}/payment/confirm`, {
    method: 'POST',
    credentials: 'include',
    headers: {
      'X-API-Key': WSIM_API_KEY,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      paymentId: paymentId,
      passkeyResponse: passkeyResponse,
    }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'Passkey verification failed');
  }

  return await response.json();
  // Returns: { walletCardToken, cardToken, bsimCardToken }
}
```

### Step 8: Complete Payment (Authorize with NSIM)

```javascript
async function completePayment(tokens) {
  // Send tokens to YOUR backend for NSIM authorization
  const response = await fetch('/api/payment/complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      walletCardToken: tokens.walletCardToken,
      cardToken: tokens.cardToken || tokens.bsimCardToken,
    }),
  });

  const result = await response.json();

  if (result.success) {
    window.location.href = result.redirectUrl;
  } else {
    throw new Error(result.error || 'Payment failed');
  }
}
```

### Complete Flow Example

```javascript
async function processDirectApiPayment(orderTotal) {
  const statusEl = document.getElementById('paymentStatus');

  try {
    // Step 1: Check if authenticated
    statusEl.textContent = 'Checking wallet...';
    const isAuthenticated = await checkWsimAuth();

    if (!isAuthenticated) {
      // Open popup for login
      openWalletLoginPopup();
      return;
    }

    // Step 2: Fetch and display cards
    statusEl.textContent = 'Loading cards...';
    const cards = await fetchCards();
    renderCards(cards, 'cardsList');

    // Wait for user to select card and click confirm
    // (handled by event listeners)

  } catch (error) {
    if (error.message.includes('Failed to fetch')) {
      statusEl.textContent = 'CORS error: Contact WSIM to allow your origin';
    } else {
      statusEl.textContent = error.message;
    }
  }
}

async function onConfirmPayment(orderTotal) {
  const statusEl = document.getElementById('paymentStatus');

  try {
    // Step 3: Initiate payment
    statusEl.textContent = 'Initiating payment...';
    const { passkeyOptions } = await initiatePayment(orderTotal);

    // Step 4: Authenticate with passkey
    statusEl.textContent = 'Waiting for passkey...';
    const passkeyResponse = await authenticateWithPasskey(passkeyOptions);

    // Step 5: Confirm payment
    statusEl.textContent = 'Verifying...';
    const tokens = await confirmPayment(passkeyResponse);

    // Step 6: Complete payment
    statusEl.textContent = 'Processing payment...';
    await completePayment(tokens);

  } catch (error) {
    statusEl.textContent = error.message;
  }
}
```

## Backend Implementation (Payment Completion)

```typescript
// POST /api/payment/complete
router.post('/api/payment/complete', async (req, res) => {
  const { walletCardToken, cardToken } = req.body;

  if (!cardToken) {
    return res.status(400).json({ error: 'Missing cardToken' });
  }

  // Get order from session
  const order = await getOrderFromSession(req);

  try {
    // Authorize with NSIM
    const authResult = await authorizePayment({
      merchantId: process.env.MERCHANT_ID,
      amount: order.total,
      currency: order.currency,
      cardToken: cardToken,
      walletCardToken: walletCardToken,
      orderId: order.id,
    });

    if (authResult.status === 'authorized') {
      await updateOrderStatus(order.id, 'authorized', {
        transactionId: authResult.transactionId,
      });

      req.session.cart = [];

      return res.json({
        success: true,
        orderId: order.id,
        redirectUrl: `/order-confirmation/${order.id}`,
      });
    } else {
      return res.status(400).json({
        success: false,
        error: authResult.declineReason || 'Payment declined',
      });
    }
  } catch (error) {
    console.error('Payment error:', error);
    return res.status(500).json({ error: 'Payment processing failed' });
  }
});
```

---

# Proxy Mode (Browser → Merchant → WSIM)

In Proxy Mode, all WSIM API calls go through your merchant backend. This eliminates CORS requirements and keeps your API key server-side.

## Architecture

```
┌──────────┐     ┌──────────────┐     ┌─────────────┐
│ Browser  │ ──► │ Your Backend │ ──► │    WSIM     │
│          │     │  (Proxy)     │     │   Backend   │
└──────────┘     └──────────────┘     └─────────────┘
                    │
                    ├─ Adds X-API-Key header
                    └─ Forwards user cookies
```

## Backend Proxy Routes

```typescript
import { Router, Request, Response } from 'express';

const router = Router();

const WSIM_API_URL = process.env.WSIM_API_URL || 'https://wsim.banksim.ca/api/merchant';
const WSIM_API_KEY = process.env.WSIM_API_KEY;

/**
 * Proxy helper - forwards request to WSIM with API key and cookies
 */
async function proxyToWsim(
  endpoint: string,
  method: 'GET' | 'POST',
  req: Request,
  body?: object
): Promise<Response> {
  const headers: Record<string, string> = {
    'X-API-Key': WSIM_API_KEY,
  };

  // Forward user's cookies for session
  if (req.headers.cookie) {
    headers['Cookie'] = req.headers.cookie;
  }

  if (method === 'POST' && body) {
    headers['Content-Type'] = 'application/json';
  }

  return fetch(`${WSIM_API_URL}${endpoint}`, {
    method,
    headers,
    body: body ? JSON.stringify(body) : undefined,
  });
}

/**
 * GET /api/wsim/auth-check
 * Check if user is authenticated with WSIM
 */
router.get('/auth-check', async (req: Request, res: Response) => {
  try {
    const response = await proxyToWsim('/user', 'GET', req);
    const data = await response.json();
    res.json(data);
  } catch (error) {
    console.error('Auth check error:', error);
    res.json({ authenticated: false });
  }
});

/**
 * GET /api/wsim/cards
 * Get user's enrolled wallet cards
 */
router.get('/cards', async (req: Request, res: Response) => {
  try {
    const response = await proxyToWsim('/cards', 'GET', req);

    if (!response.ok) {
      const error = await response.json();
      return res.status(response.status).json(error);
    }

    const data = await response.json();
    res.json(data);
  } catch (error) {
    console.error('Cards error:', error);
    res.status(500).json({ error: 'Failed to fetch cards' });
  }
});

/**
 * POST /api/wsim/payment/initiate
 * Start payment and get WebAuthn challenge
 */
router.post('/payment/initiate', async (req: Request, res: Response) => {
  const { cardId, amount, currency = 'CAD' } = req.body;

  if (!cardId || !amount) {
    return res.status(400).json({ error: 'Missing cardId or amount' });
  }

  try {
    const response = await proxyToWsim('/payment/initiate', 'POST', req, {
      cardId,
      amount,
      currency,
      merchantName: 'Your Store Name',
    });

    if (!response.ok) {
      const error = await response.json();
      return res.status(response.status).json(error);
    }

    const data = await response.json();
    res.json(data);
  } catch (error) {
    console.error('Payment initiate error:', error);
    res.status(500).json({ error: 'Failed to initiate payment' });
  }
});

/**
 * POST /api/wsim/payment/confirm
 * Verify passkey and get payment tokens
 */
router.post('/payment/confirm', async (req: Request, res: Response) => {
  const { paymentId, passkeyResponse } = req.body;

  if (!paymentId || !passkeyResponse) {
    return res.status(400).json({ error: 'Missing paymentId or passkeyResponse' });
  }

  try {
    const response = await proxyToWsim('/payment/confirm', 'POST', req, {
      paymentId,
      passkeyResponse,
    });

    if (!response.ok) {
      const error = await response.json();
      return res.status(response.status).json(error);
    }

    const data = await response.json();
    res.json(data);
  } catch (error) {
    console.error('Payment confirm error:', error);
    res.status(500).json({ error: 'Passkey verification failed' });
  }
});

/**
 * POST /api/wsim/payment/complete
 * Complete payment with NSIM using tokens from WSIM
 */
router.post('/payment/complete', async (req: Request, res: Response) => {
  const { walletCardToken, cardToken } = req.body;

  if (!cardToken) {
    return res.status(400).json({ error: 'Missing cardToken' });
  }

  // Get order from session
  const order = await getOrderFromSession(req);

  try {
    const authResult = await authorizePayment({
      merchantId: process.env.MERCHANT_ID,
      amount: order.total,
      currency: order.currency,
      cardToken,
      walletCardToken,
      orderId: order.id,
    });

    if (authResult.status === 'authorized') {
      await updateOrderStatus(order.id, 'authorized', {
        transactionId: authResult.transactionId,
      });

      req.session.cart = [];

      res.json({
        success: true,
        orderId: order.id,
        redirectUrl: `/order-confirmation/${order.id}`,
      });
    } else {
      res.status(400).json({
        error: 'Payment declined',
        reason: authResult.declineReason,
      });
    }
  } catch (error) {
    console.error('Payment complete error:', error);
    res.status(500).json({ error: 'Payment processing failed' });
  }
});

export default router;
```

## Frontend Implementation (Proxy Mode)

The frontend is nearly identical to Direct API mode, but calls your proxy endpoints:

```javascript
// Configuration - calls YOUR backend instead of WSIM directly
const API_BASE = '/api/wsim';
const WSIM_POPUP_URL = 'https://wsim-auth.banksim.ca';

let selectedCardId = null;
let paymentId = null;

async function checkWsimAuth() {
  const response = await fetch(`${API_BASE}/auth-check`);
  const data = await response.json();
  return data.authenticated === true;
}

async function fetchCards() {
  const response = await fetch(`${API_BASE}/cards`);
  if (!response.ok) {
    throw new Error('Failed to fetch cards');
  }
  const data = await response.json();
  return data.cards || [];
}

async function initiatePayment(amount, currency = 'CAD') {
  const response = await fetch(`${API_BASE}/payment/initiate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      cardId: selectedCardId,
      amount: amount.toFixed(2),
      currency,
    }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'Failed to initiate payment');
  }

  const data = await response.json();
  paymentId = data.paymentId;
  return data;
}

async function confirmPayment(passkeyResponse) {
  const response = await fetch(`${API_BASE}/payment/confirm`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      paymentId,
      passkeyResponse,
    }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'Passkey verification failed');
  }

  return await response.json();
}

async function completePayment(tokens) {
  const response = await fetch(`${API_BASE}/payment/complete`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      walletCardToken: tokens.walletCardToken,
      cardToken: tokens.cardToken || tokens.bsimCardToken,
    }),
  });

  const result = await response.json();

  if (result.success) {
    window.location.href = result.redirectUrl;
  } else {
    throw new Error(result.error || 'Payment failed');
  }
}

// Complete flow
async function processProxyPayment(orderTotal) {
  try {
    const isAuthenticated = await checkWsimAuth();

    if (!isAuthenticated) {
      // Open WSIM popup for login
      openWalletLoginPopup();
      return;
    }

    const cards = await fetchCards();
    renderCards(cards, 'cardsList');

  } catch (error) {
    console.error('Payment error:', error);
    showError(error.message);
  }
}

async function onConfirmPayment(orderTotal) {
  try {
    const { passkeyOptions } = await initiatePayment(orderTotal);
    const passkeyResponse = await authenticateWithPasskey(passkeyOptions);
    const tokens = await confirmPayment(passkeyResponse);
    await completePayment(tokens);
  } catch (error) {
    showError(error.message);
  }
}
```

---

# API Mode (Hybrid Backend Proxy)

API Mode is functionally the same as Proxy Mode in SSIM's implementation. The distinction is primarily naming - both route API calls through the merchant backend.

The key difference from Direct API mode:
- **Direct API**: Browser → WSIM (requires CORS)
- **API/Proxy Mode**: Browser → Merchant Backend → WSIM (no CORS needed)

See the Proxy Mode section above for the complete implementation.

---

# Handling Unauthenticated Users

All three API modes need to handle the case where the user doesn't have a WSIM session.

## Opening Login Popup

```javascript
const WSIM_POPUP_URL = 'https://wsim-auth.banksim.ca';

function openWalletLoginPopup() {
  // Calculate centered position
  const width = 420;
  const height = 620;
  const left = (screen.width - width) / 2;
  const top = (screen.height - height) / 2;

  // Build popup URL - omit amount to just get authentication
  const params = new URLSearchParams({
    origin: window.location.origin,
    merchantId: 'your-merchant-id',
    merchantName: 'Your Store Name',
  });

  const popup = window.open(
    `${WSIM_POPUP_URL}/popup/card-picker?${params}`,
    'wsim-login',
    `width=${width},height=${height},left=${left},top=${top}`
  );

  // Handle popup messages
  let paymentCompleted = false;

  const handleMessage = async (event) => {
    // CRITICAL: Verify origin
    if (!event.origin.startsWith(WSIM_POPUP_URL)) return;

    const { type, ...data } = event.data;

    if (type === 'wsim:card-selected') {
      paymentCompleted = true;
      window.removeEventListener('message', handleMessage);
      popup.close();

      // User authenticated and selected a card - process payment
      if (data.cardToken) {
        await completePayment(data);
      } else {
        // Refresh card picker now that user is authenticated
        showCardPicker();
      }
    } else if (type === 'wsim:cancelled') {
      paymentCompleted = true;
      window.removeEventListener('message', handleMessage);
      popup.close();
    }
  };

  window.addEventListener('message', handleMessage);

  // Monitor for popup closure
  const checkInterval = setInterval(() => {
    if (popup.closed) {
      clearInterval(checkInterval);
      window.removeEventListener('message', handleMessage);
      if (!paymentCompleted) {
        // User closed popup after authenticating - refresh card picker
        showCardPicker();
      }
    }
  }, 500);
}
```

---

# CORS Troubleshooting

## Common Errors

### "Access-Control-Allow-Origin missing"

```
Cause: WSIM doesn't allow your origin
Fix: Contact WSIM admin to add your origin to CORS_ORIGINS
```

### "Cookie not sent in cross-origin request"

```
Cause: Missing credentials option
Fix: Add credentials: 'include' to all fetch calls
```

### "credentials not supported if origin is '*'"

```
Cause: WSIM using wildcard CORS origin
Fix: WSIM must specify explicit origins when credentials are required
```

## Quick Checklist

For **Direct API** mode to work:

- [ ] Your origin in WSIM `CORS_ORIGINS`
- [ ] All fetch calls include `credentials: 'include'`
- [ ] `X-API-Key` header on all requests
- [ ] WSIM session cookie has `SameSite=None; Secure`
- [ ] Using HTTPS

For **Proxy Mode**:

- [ ] Backend has valid `WSIM_API_KEY`
- [ ] Backend forwards user cookies to WSIM
- [ ] WSIM origin in `CORS_ORIGINS` (for proxy's backend-to-backend calls)

---

# Complete Example: Checkout Page HTML

```html
<!DOCTYPE html>
<html>
<head>
  <title>Checkout</title>
  <script src="https://cdn.jsdelivr.net/npm/@simplewebauthn/browser@10/dist/bundle/index.umd.min.js"></script>
</head>
<body>
  <h1>Checkout</h1>

  <div id="orderSummary">
    <p>Total: <strong id="orderTotal">$104.99</strong></p>
  </div>

  <div id="paymentSection">
    <h2>Select Payment Card</h2>

    <!-- Loading State -->
    <div id="loadingState">Loading wallet...</div>

    <!-- Not Authenticated State -->
    <div id="notAuthState" style="display: none;">
      <p>Please sign in to your wallet</p>
      <button onclick="openWalletLoginPopup()">Sign In to Wallet</button>
    </div>

    <!-- Cards List -->
    <div id="cardsList" style="display: none;"></div>

    <!-- Confirm Button -->
    <button
      id="confirmButton"
      onclick="onConfirmPayment(104.99)"
      disabled
      style="display: none;"
    >
      Confirm with Passkey
    </button>

    <!-- Status -->
    <p id="paymentStatus"></p>
  </div>

  <script>
    // Configuration (use Direct API or Proxy Mode)
    const USE_PROXY = true;
    const API_BASE = USE_PROXY ? '/api/wsim' : 'https://wsim.banksim.ca/api/merchant';
    const WSIM_API_KEY = 'wsim_api_xxx';  // Only needed for Direct API
    const WSIM_POPUP_URL = 'https://wsim-auth.banksim.ca';

    let selectedCardId = null;
    let paymentId = null;

    // ... (include all functions from above)

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const isAuthenticated = await checkWsimAuth();

        document.getElementById('loadingState').style.display = 'none';

        if (!isAuthenticated) {
          document.getElementById('notAuthState').style.display = 'block';
          return;
        }

        const cards = await fetchCards();
        renderCards(cards, 'cardsList');
        document.getElementById('cardsList').style.display = 'block';
        document.getElementById('confirmButton').style.display = 'block';

      } catch (error) {
        document.getElementById('loadingState').textContent = error.message;
      }
    });
  </script>
</body>
</html>
```

---

## Configuration Reference

### SSIM Environment
```env
# WSIM Integration
WSIM_ENABLED=true
WSIM_AUTH_URL=https://wsim-auth.banksim.ca
WSIM_CLIENT_ID=ssim-merchant
WSIM_CLIENT_SECRET=xxx
WSIM_API_URL=https://wsim.banksim.ca/api/merchant
WSIM_API_KEY=wsim_api_xxx
```

### WSIM Auth Server Environment
```env
ALLOWED_POPUP_ORIGINS=https://ssim.banksim.ca,https://ssim-dev.banksim.ca
ALLOWED_EMBED_ORIGINS=https://ssim.banksim.ca,https://ssim-dev.banksim.ca
WEBAUTHN_RP_NAME=WSIM Wallet
WEBAUTHN_RP_ID=banksim.ca
WEBAUTHN_ORIGINS=https://wsim.banksim.ca,https://wsim-auth.banksim.ca,https://ssim.banksim.ca
INTERNAL_API_SECRET=xxx
BACKEND_URL=http://wsim-backend:3001
```

### WSIM Backend Environment
```env
WEBAUTHN_RP_ID=banksim.ca
WEBAUTHN_ORIGINS=https://wsim.banksim.ca,https://wsim-auth.banksim.ca,https://ssim.banksim.ca
BSIM_PROVIDERS=[{"bsimId":"banksim","name":"Bank Simulator",...}]
```

---

*Document created: 2024-12-07*
